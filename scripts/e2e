#!/bin/bash

set -eo pipefail
source $(pwd)/scripts/evm

### Setup
# Compile contracts
yarn build

# Start evm
evm_kill
evm_start
sleep 5

# Pre-deploy actions
npx hardhat migrate:accounts --network localhost --graph-config config/graph.localhost.yml

# Deploy protocol
npx hardhat migrate --network localhost --skip-confirmation --graph-config config/graph.localhost.yml

# Post deploy actions
npx hardhat migrate:ownership --network localhost --graph-config config/graph.localhost.yml
npx hardhat migrate:unpause --network localhost --graph-config config/graph.localhost.yml

### Test
# Run tests using the localhost evm instance and the localhost graph config
npx hardhat e2e --network localhost --graph-config config/graph.localhost.yml
npx hardhat e2e:scenario create-subgraphs --network localhost --graph-config config/graph.localhost.yml
npx hardhat e2e:scenario open-allocations --network localhost --graph-config config/graph.localhost.yml
npx hardhat e2e:scenario close-allocations --network localhost --graph-config config/graph.localhost.yml

### Cleanup
# Exit error mode so the evm instance always gets killed
set +e
result=0

evm_kill
exit $result
