#!/bin/bash

set -eo pipefail
source $(pwd)/scripts/evm

### Setup
# Compile contracts
yarn build

# Start evm
evm_kill
evm_start
sleep 5

# Pre-deploy actions
npx hardhat migrate:accounts --network localhost --graph-config config/graph.localhost.yml

# Deploy protocol
npx hardhat migrate --network localhost --skip-confirmation --graph-config config/graph.localhost.yml

# Post deploy actions
npx hardhat migrate:ownership --network localhost
npx hardhat migrate:unpause --network localhost

### Test
# Run tests using the localhost evm instance and the localhost graph config
GRAPH_CONFIG='config/graph.localhost.yml' npx hardhat test e2e/**/*.ts --network localhost


### Cleanup
# Exit error mode so the evm instance always gets killed
set +e
result=0

evm_kill
exit $result
