#!/bin/bash

set -eo pipefail

# Check required env variables
if [ -z "$ARBITRUM_SEPOLIA_RPC" ]; then
    echo "ARBITRUM_SEPOLIA_RPC environment variable is required"
    exit 1
fi

if [ -z "$DEPLOYER_PRIVATE_KEY" ]; then
    echo "DEPLOYER_PRIVATE_KEY environment variable is required"
    exit 1
fi

if [ -z "$GOVERNOR_PRIVATE_KEY" ]; then
    echo "GOVERNOR_PRIVATE_KEY environment variable is required"
    exit 1
fi

echo "Starting e2e tests..."

# Check if port 8545 is in use
if lsof -i:8545 > /dev/null 2>&1; then
    echo "Error: Port 8545 is already in use"
    exit 1
fi

# Start local hardhat node forked from Arbitrum Sepolia
echo "Starting local hardhat node..."
npx hardhat node --fork $ARBITRUM_SEPOLIA_RPC > node.log 2>&1 &
NODE_PID=$!

# Wait for node to start
sleep 10

# Run migration steps
echo "Running migration steps..."

# Step 1 - Deployer
echo "Step 1 - Deployer"
npx hardhat deploy:migrate --network localhost --step 1

# Step 2 - Governor
echo "Step 2 - Governor"
npx hardhat deploy:migrate --network localhost --step 2 --patch-config

# Step 3 - Deployer
echo "Step 3 - Deployer"
npx hardhat deploy:migrate --network localhost --step 3 --patch-config

# Step 4 - Governor
echo "Step 4 - Governor"
npx hardhat deploy:migrate --network localhost --step 4 --patch-config

# Run integration tests - During transition period
echo "Running during-transition-period tests..."
npx hardhat test:integration --phase during-transition --network localhost

# Clear thawing period
echo "Clearing thawing period..."
npx hardhat transition:clear-thawing

# Run integration tests - After transition period
echo "Running after-transition-period tests..."
npx hardhat test:integration --phase after-transition --network localhost

# Enable delegation slashing
echo "Enabling delegation slashing..."
npx hardhat transition:enable-delegation-slashing

# Run integration tests - After delegation slashing enabled
echo "Running after-delegation-slashing tests..."
npx hardhat test:integration --phase after-delegation-slashing --network localhost

# Cleanup
kill $NODE_PID

echo "E2E tests completed successfully!"
